// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test, console} from "forge-std/Test.sol";
import {MasterRegistryV1} from "../../src/master/MasterRegistryV1.sol";
import {MasterRegistry} from "../../src/master/MasterRegistry.sol";
import {IMasterRegistry} from "../../src/master/interfaces/IMasterRegistry.sol";
import {TestHelpers} from "../helpers/TestHelpers.sol";

/**
 * @title VaultHookRegistryTest
 * @notice Comprehensive test suite for vault and hook registry functionality
 * @dev SKIPPED: Hook registry has been removed as part of vault-hook redesign
 * Hooks are now created and owned by vaults, not registered centrally in MasterRegistry
 * These tests are kept for reference only and all are now skipped
 */
contract SkipVaultHookRegistryTest is Test {
    MasterRegistryV1 public implementation;
    MasterRegistry public proxyWrapper;
    address public proxy;
    
    // Mock contracts
    address public mockVault1;
    address public mockVault2;
    address public mockHook1;
    address public mockHook2;
    address public mockHook3;
    
    address public owner;
    address public vaultCreator1;
    address public vaultCreator2;
    address public hookCreator1;
    address public hookCreator2;
    
    uint256 constant VAULT_REGISTRATION_FEE = 0.05 ether;
    uint256 constant HOOK_REGISTRATION_FEE = 0.02 ether;

    function setUp() public {
        owner = address(this);
        vaultCreator1 = address(0x111);
        vaultCreator2 = address(0x222);
        hookCreator1 = address(0x333);
        hookCreator2 = address(0x444);

        // Deploy mock contracts (simple contracts for testing)
        mockVault1 = address(new MockContract());
        mockVault2 = address(new MockContract());
        mockHook1 = address(new MockContract());
        mockHook2 = address(new MockContract());
        mockHook3 = address(new MockContract());

        // Deploy implementation
        implementation = new MasterRegistryV1();
        
        // Deploy proxy wrapper with initialization
        bytes memory initData = abi.encodeWithSelector(
            MasterRegistryV1.initialize.selector,
            address(0x123), // Mock EXEC token
            owner
        );
        proxyWrapper = new MasterRegistry(address(implementation), initData);
        
        // Extract the actual proxy address
        proxy = TestHelpers.getProxyAddress(proxyWrapper);
    }

    // ============ Vault Registration Tests ============

    function test_RegisterVault_Success() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );

        IMasterRegistry.VaultInfo memory info = registry.getVaultInfo(mockVault1);
        
        assertEq(info.vault, mockVault1);
        assertEq(info.creator, vaultCreator1);
        assertEq(info.name, "Test Vault");
        assertEq(info.metadataURI, "https://example.com/vault1.json");
        assertTrue(info.active);
        assertGt(info.registeredAt, 0);
        assertEq(info.instanceCount, 0);
        
        assertTrue(registry.isVaultRegistered(mockVault1));
    }

    function test_RegisterVault_InsufficientFee() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE - 1);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        vm.expectRevert("Insufficient registration fee");
        registry.registerVault{value: VAULT_REGISTRATION_FEE - 1}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
    }

    function test_RegisterVault_InvalidAddress() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        vm.expectRevert("Invalid vault address");
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            address(0),
            "Test Vault",
            "https://example.com/vault1.json"
        );
    }

    function test_RegisterVault_InvalidMetadataURI() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        vm.expectRevert("Invalid metadata URI");
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "invalid-uri"
        );
    }

    function test_RegisterVault_NotAContract() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        vm.expectRevert("Vault must be a contract");
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            address(0x999), // EOA address
            "Test Vault",
            "https://example.com/vault1.json"
        );
    }

    function test_RegisterVault_Duplicate() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE * 2);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.startPrank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.expectRevert("Vault already registered");
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault 2",
            "https://example.com/vault2.json"
        );
        vm.stopPrank();
    }

    function test_RegisterVault_ExcessPaymentRefund() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE * 2);
        uint256 initialBalance = vaultCreator1.balance;
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE * 2}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        // Should refund excess
        assertEq(vaultCreator1.balance, initialBalance - VAULT_REGISTRATION_FEE);
    }

    function test_RegisterVault_MultipleVaults() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.deal(vaultCreator2, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Vault 1",
            "https://example.com/vault1.json"
        );
        
        vm.prank(vaultCreator2);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault2,
            "Vault 2",
            "https://example.com/vault2.json"
        );
        
        address[] memory vaultList = registry.getVaultList();
        assertEq(vaultList.length, 2);
        assertEq(vaultList[0], mockVault1);
        assertEq(vaultList[1], mockVault2);
    }

    // ============ Hook Registration Tests ============

    function test_RegisterHook_Success() public {
        // First register a vault
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        // Register hook - SKIPPED: registerHook removed in vault-hook redesign
        // vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);

        // vm.prank(hookCreator1);
        // registry.registerHook{value: HOOK_REGISTRATION_FEE}(
        //     mockHook1,
        //     mockVault1,
        //     "Test Hook",
        //     "https://example.com/hook1.json"
        // );

        // Hook registry removed in vault-hook redesign - hooks now owned by vaults
        // IMasterRegistry.HookInfo memory info = registry.getHookInfo(mockHook1);
        // assertEq(info.hook, mockHook1);
        // assertEq(info.creator, hookCreator1);
        // assertEq(info.vault, mockVault1);
        // assertEq(info.name, "Test Hook");
        // assertEq(info.metadataURI, "https://example.com/hook1.json");
        // assertTrue(info.active);
        // assertGt(info.registeredAt, 0);
        // assertEq(info.instanceCount, 0);

        // assertTrue(registry.isHookRegistered(mockHook1));
    }

    function test_RegisterHook_VaultNotRegistered() public {
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(hookCreator1);
        vm.expectRevert("Vault must be registered");
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1, // Not registered
            "Test Hook",
            "https://example.com/hook1.json"
        );
    }

    function test_RegisterHook_InsufficientFee() public {
        // First register a vault
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE - 1);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(hookCreator1);
        vm.expectRevert("Insufficient registration fee");
        registry.registerHook{value: HOOK_REGISTRATION_FEE - 1}(
            mockHook1,
            mockVault1,
            "Test Hook",
            "https://example.com/hook1.json"
        );
    }

    function test_RegisterHook_MultipleHooksPerVault() public {
        // Register vault
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        // Register multiple hooks for same vault
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE * 3);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.startPrank(hookCreator1);
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Hook 1",
            "https://example.com/hook1.json"
        );
        
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook2,
            mockVault1,
            "Hook 2",
            "https://example.com/hook2.json"
        );
        
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook3,
            mockVault1,
            "Hook 3",
            "https://example.com/hook3.json"
        );
        vm.stopPrank();
        
        address[] memory hooks = registry.getHooksByVault(mockVault1);
        assertEq(hooks.length, 3);
        assertEq(hooks[0], mockHook1);
        assertEq(hooks[1], mockHook2);
        assertEq(hooks[2], mockHook3);
    }

    function test_RegisterHook_DifferentVaults() public {
        // Register two vaults
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE * 2);
        vm.startPrank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Vault 1",
            "https://example.com/vault1.json"
        );
        
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault2,
            "Vault 2",
            "https://example.com/vault2.json"
        );
        vm.stopPrank();
        
        // Register hooks for different vaults
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE * 2);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.startPrank(hookCreator1);
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Hook for Vault 1",
            "https://example.com/hook1.json"
        );
        
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook2,
            mockVault2,
            "Hook for Vault 2",
            "https://example.com/hook2.json"
        );
        vm.stopPrank();
        
        address[] memory vault1Hooks = registry.getHooksByVault(mockVault1);
        address[] memory vault2Hooks = registry.getHooksByVault(mockVault2);
        
        assertEq(vault1Hooks.length, 1);
        assertEq(vault1Hooks[0], mockHook1);
        
        assertEq(vault2Hooks.length, 1);
        assertEq(vault2Hooks[0], mockHook2);
    }

    // ============ Query Function Tests ============

    function test_GetVaultList_Empty() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        address[] memory vaultList = registry.getVaultList();
        assertEq(vaultList.length, 0);
    }

    function test_GetHookList_Empty() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        address[] memory hookList = registry.getHookList();
        assertEq(hookList.length, 0);
    }

    function test_GetVaultList_Multiple() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE * 3);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.startPrank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Vault 1",
            "https://example.com/vault1.json"
        );
        
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault2,
            "Vault 2",
            "https://example.com/vault2.json"
        );
        vm.stopPrank();
        
        address[] memory vaultList = registry.getVaultList();
        assertEq(vaultList.length, 2);
    }

    function test_GetHookList_Multiple() public {
        // Register vault first
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        // Register multiple hooks
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE * 3);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.startPrank(hookCreator1);
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Hook 1",
            "https://example.com/hook1.json"
        );
        
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook2,
            mockVault1,
            "Hook 2",
            "https://example.com/hook2.json"
        );
        vm.stopPrank();
        
        address[] memory hookList = registry.getHookList();
        assertEq(hookList.length, 2);
    }

    function test_IsVaultRegistered_NotRegistered() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        assertFalse(registry.isVaultRegistered(mockVault1));
    }

    function test_IsHookRegistered_NotRegistered() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        assertFalse(registry.isHookRegistered(mockHook1));
    }

    // ============ Deactivation Tests ============

    function test_DeactivateVault_Success() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        assertTrue(registry.isVaultRegistered(mockVault1));
        
        // Deactivate
        registry.deactivateVault(mockVault1);
        
        // Should still be registered but inactive
        assertFalse(registry.isVaultRegistered(mockVault1)); // Checks active status
        
        IMasterRegistry.VaultInfo memory info = registry.getVaultInfo(mockVault1);
        assertFalse(info.active);
    }

    function test_DeactivateVault_NotOwner() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(vaultCreator1); // Not owner
        vm.expectRevert();
        registry.deactivateVault(mockVault1);
    }

    function test_DeactivateHook_Success() public {
        // Register vault and hook
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        vm.prank(hookCreator1);
        MasterRegistryV1(proxy).registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Test Hook",
            "https://example.com/hook1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        assertTrue(registry.isHookRegistered(mockHook1));
        
        // Deactivate
        registry.deactivateHook(mockHook1);
        
        // Should still be registered but inactive
        assertFalse(registry.isHookRegistered(mockHook1)); // Checks active status

        // Hook registry removed in vault-hook redesign - hooks now owned by vaults
        // IMasterRegistry.HookInfo memory info = registry.getHookInfo(mockHook1);
        // assertFalse(info.active);
    }

    function test_DeactivateHook_NotOwner() public {
        // Register vault and hook
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        vm.prank(hookCreator1);
        MasterRegistryV1(proxy).registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Test Hook",
            "https://example.com/hook1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.prank(hookCreator1); // Not owner
        vm.expectRevert();
        registry.deactivateHook(mockHook1);
    }

    // ============ Fee Configuration Tests ============
    // Phase 1 Note: Fee configuration is deferred to Phase 2
    // These test functions are skipped and their implementation is commented out
    /*
    function test_SetVaultRegistrationFee() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);

        uint256 newFee = 0.1 ether;
        registry.setVaultRegistrationFee(newFee);

        assertEq(registry.vaultRegistrationFee(), newFee);
    }

    function test_SetHookRegistrationFee() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);

        uint256 newFee = 0.05 ether;
        registry.setHookRegistrationFee(newFee);

        assertEq(registry.hookRegistrationFee(), newFee);
    }

    function test_SetVaultRegistrationFee_NotOwner() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);

        vm.prank(vaultCreator1); // Not owner
        vm.expectRevert();
        registry.setVaultRegistrationFee(0.1 ether);
    }

    function test_SetHookRegistrationFee_NotOwner() public {
        MasterRegistryV1 registry = MasterRegistryV1(proxy);

        vm.prank(hookCreator1); // Not owner
        vm.expectRevert();
        registry.setHookRegistrationFee(0.05 ether);
    }
    */

    // ============ Events Tests ============

    function test_VaultRegistered_Event() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.expectEmit(true, true, false, false);
        emit IMasterRegistry.VaultRegistered(
            mockVault1,
            vaultCreator1,
            "Test Vault",
            VAULT_REGISTRATION_FEE
        );
        
        vm.prank(vaultCreator1);
        registry.registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
    }

    function test_HookRegistered_Event() public {
        // Register vault first
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.expectEmit(true, true, true, false);
        emit IMasterRegistry.HookRegistered(
            mockHook1,
            hookCreator1,
            mockVault1,
            "Test Hook",
            HOOK_REGISTRATION_FEE
        );
        
        vm.prank(hookCreator1);
        registry.registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Test Hook",
            "https://example.com/hook1.json"
        );
    }

    function test_VaultDeactivated_Event() public {
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.expectEmit(true, false, false, false);
        emit IMasterRegistry.VaultDeactivated(mockVault1);
        
        registry.deactivateVault(mockVault1);
    }

    function test_HookDeactivated_Event() public {
        // Register vault and hook
        vm.deal(vaultCreator1, VAULT_REGISTRATION_FEE);
        vm.prank(vaultCreator1);
        MasterRegistryV1(proxy).registerVault{value: VAULT_REGISTRATION_FEE}(
            mockVault1,
            "Test Vault",
            "https://example.com/vault1.json"
        );
        
        vm.deal(hookCreator1, HOOK_REGISTRATION_FEE);
        vm.prank(hookCreator1);
        MasterRegistryV1(proxy).registerHook{value: HOOK_REGISTRATION_FEE}(
            mockHook1,
            mockVault1,
            "Test Hook",
            "https://example.com/hook1.json"
        );
        
        MasterRegistryV1 registry = MasterRegistryV1(proxy);
        
        vm.expectEmit(true, false, false, false);
        emit IMasterRegistry.HookDeactivated(mockHook1);
        
        registry.deactivateHook(mockHook1);
    }
}

/**
 * @title MockContract
 * @notice Simple mock contract for testing (has code.length > 0)
 */
contract MockContract {
    uint256 public value;
    
    function setValue(uint256 _value) external {
        value = _value;
    }
}

